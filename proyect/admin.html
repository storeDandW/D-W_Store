<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Administrador</title>
<link rel="stylesheet" href="css/estilos.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
</head>
<body>

<div class="container py-5">

  <!-- LOGIN -->
  <div id="loginAdmin" class="row justify-content-center">
    <div class="col-md-4">
      <div class="card card-admin p-4">
        <h4 class="text-center mb-4">游댏 Ingreso Administrador</h4>
        <input type="email" id="email" class="form-control mb-3" placeholder="Email">
        <input type="password" id="password" class="form-control mb-3" placeholder="Contrase침a">
        <button id="btnLogin" class="btn btn-primary w-100">Ingresar</button>
      </div>
    </div>
  </div>

  <!-- PANEL -->
  <div id="panelAdmin" style="display:none;">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>游 Panel Administrador D&W</h2>
	  <span id="adminEmail" class="me-3 text-muted"></span>
      <button id="btnLogout" class="btn btn-outline-danger">Cerrar sesi칩n</button>
    </div>

    <!-- AGREGAR PRODUCTO -->
    <div class="card card-admin p-4 mb-4">
      <h5 class="section-title">Agregar Producto</h5>
      <div class="row">
        <div class="col-md-6 mb-3">
          <input type="text" id="nombre" class="form-control" placeholder="Nombre">
        </div>
        <div class="col-md-6 mb-3">
          <input type="number" id="precio" class="form-control" placeholder="Precio">
        </div>
        <div class="col-md-12 mb-3">
          <input type="text" id="descripcion" class="form-control" placeholder="Descripci칩n">
        </div>
        <div class="col-md-6 mb-3">
          <input type="number" id="stock" class="form-control" placeholder="Stock">
        </div>
        <div class="col-md-6 mb-3">
          <input type="file" id="imagenes" class="form-control" multiple>
        </div>
	<div class="col-12 mb-4">
  <label class="form-label fw-bold">
    Caracter칤sticas (una por l칤nea)
  </label>

  <textarea 
    id="caracteristicas"
    class="form-control"
    rows="4"
    placeholder="Pantalla 15.6 pulgadas
Resoluci칩n 1080P
USB-C
Altavoces integrados">
  </textarea>

  <small class="text-muted">
    Escribe una caracter칤stica por cada l칤nea.
  </small>
</div>
      </div>
     <button onclick="agregarProducto()">Guardar</button>
    </div>

    <!-- PRODUCTOS -->
    <div class="card card-admin p-4 mb-4">
      <h5 class="section-title">Productos</h5>
	  <div class="mb-3">
  <input type="text" 
         id="buscadorProducto" 
         class="form-control" 
         placeholder="游댍 Buscar producto por nombre...">
</div>
      <div id="adminProductos"></div>
    </div>

    <!-- VENTAS -->
    <div class="card card-admin p-4">
      <h5 class="section-title">Ventas Pendientes</h5>
      <div id="ventas"></div>
    </div>

  </div>
  
  

</div>
<div class="modal fade" id="modalEditar" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <!-- HEADER -->
      <div class="modal-header">
        <h5 class="modal-title">Editar Producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- BODY -->
      <div class="modal-body">

        <input type="hidden" id="edit_id">

        <div class="mb-3">
          <label class="form-label">Nombre</label>
          <input type="text" id="edit_nombre" class="form-control">
        </div>

        <div class="mb-3">
          <label class="form-label">Descripci칩n</label>
          <textarea id="edit_descripcion" class="form-control"></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">
            Caracter칤sticas (una por l칤nea)
          </label>
          <textarea 
            id="edit_caracteristicas"
            class="form-control"
            rows="4">
          </textarea>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Precio</label>
            <input type="number" id="edit_precio" class="form-control">
          </div>

          <div class="col-md-6 mb-3">
            <label class="form-label">Stock</label>
            <input type="number" id="edit_stock" class="form-control">
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Nueva Imagen (opcional)</label>
          <input type="file" id="edit_imagen" class="form-control">
        </div>

        <div class="text-center mt-3">
          <img 
            id="previewImagen"
            class="img-fluid rounded shadow-sm"
            style="max-height:200px; object-fit:contain;">
        </div>

      </div>

      <!-- FOOTER (AHORA BIEN UBICADO) -->
      <div class="modal-footer justify-content-center">

        <button class="btn btn-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <button class="btn btn-primary" id="btnGuardarCambios">
          Guardar Cambios
        </button>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBT92uxNr4IJrsBf0VPU2piMQz4gCAk46o",
  authDomain: "proyecto-wd.firebaseapp.com",
  projectId: "proyecto-wd",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// 游댠 MISMA CONFIG CLOUDINARY
const CLOUD_NAME = "dxkblftsu";
const UPLOAD_PRESET = "tienda_DG";

async function subirImagen(file){
  const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", UPLOAD_PRESET);

  const res = await fetch(url, {
    method: "POST",
    body: formData
  });

  const data = await res.json();
  return data.secure_url;
}
document.getElementById("btnLogin").addEventListener("click", async () => {

  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  try {
    await signInWithEmailAndPassword(auth, email, password);
    alert("Login correcto");

  } catch (error) {
    console.error(error);
    alert("Credenciales incorrectas");
  }

});



// Verificar admin
async function esAdmin(uid){
  const ref = doc(db,"admins",uid);
  const snap = await getDoc(ref);
  return snap.exists();
}

function mostrarPanel(show){
  document.getElementById("panelAdmin").style.display = show ? "block" : "none";
  document.getElementById("loginAdmin").style.display = show ? "none" : "block";
}

window.login = async function(){
  await signInWithEmailAndPassword(auth,
    email.value,
    password.value
  );
}

window.logout = async function(){
  await signOut(auth);
}

onAuthStateChanged(auth, async (user)=>{
  if(user){
    const admin = await esAdmin(user.uid);
    if(admin){
      mostrarPanel(true);
      cargarAdminProductos();
      cargarVentas();
    } else {
      alert("No eres admin");
      await signOut(auth);
    }
  } else {
    mostrarPanel(false);
  }
});

window.agregarProducto = async function(){

  const files = document.getElementById("imagenes").files;
  let urls = [];

  // 游댳 Subir im치genes
  if(files.length > 0){
    for(let i = 0; i < files.length; i++){
      const url = await subirImagen(files[i]);
      urls.push(url);
    }
  }

  // 游댳 Procesar caracter칤sticas (una por l칤nea)
  const caracteristicasTexto = document.getElementById("caracteristicas").value;

  const caracteristicasArray = caracteristicasTexto
    .split("\n")
    .map(c => c.trim())
    .filter(c => c !== "");

  // 游댳 Guardar en Firestore
  await addDoc(collection(db,"productos"),{
    nombre: document.getElementById("nombre").value,
    descripcion: document.getElementById("descripcion").value,
    precio: Number(document.getElementById("precio").value),
    stock: Number(document.getElementById("stock").value),
    imagenes: urls,
    caracteristicas: caracteristicasArray  // 游녣 agregado
  });

  // 游댳 Limpiar formulario
  document.getElementById("nombre").value = "";
  document.getElementById("descripcion").value = "";
  document.getElementById("precio").value = "";
  document.getElementById("stock").value = "";
  document.getElementById("imagenes").value = "";
  document.getElementById("caracteristicas").value = "";

  cargarProductos();
  cargarAdminProductos();
};



let modalEditar = new bootstrap.Modal(document.getElementById('modalEditar'));

window.abrirModalEditar = async function(id){

  const snap = await getDoc(doc(db,"productos",id));
  const data = snap.data();

  document.getElementById("edit_id").value = id;
  document.getElementById("edit_nombre").value = data.nombre;
  document.getElementById("edit_descripcion").value = data.descripcion || "";
  document.getElementById("edit_precio").value = data.precio;
  document.getElementById("edit_stock").value = data.stock;

  // 游댳 Cargar imagen principal
  const imagen = data.imagenes?.[0] || data.imagen || "";
  document.getElementById("previewImagen").src = imagen;

  // 游댳 Cargar caracter칤sticas
  const textarea = document.getElementById("edit_caracteristicas");

  if(data.caracteristicas && Array.isArray(data.caracteristicas)){
    textarea.value = data.caracteristicas.join("\n");
  } else {
    textarea.value = "";
  }

  modalEditar.show();
};

document.getElementById("btnGuardarCambios").addEventListener("click", async ()=>{

  const id = document.getElementById("edit_id").value;
  const file = document.getElementById("edit_imagen").files[0];
  const caracteristicasTexto = document.getElementById("edit_caracteristicas").value;
  const caracteristicasArray = caracteristicasTexto
  .split("\n")
  .map(c => c.trim())
  .filter(c => c !== "");

 
let updateData = {
  nombre: document.getElementById("edit_nombre").value,
  descripcion: document.getElementById("edit_descripcion").value,
  precio: Number(document.getElementById("edit_precio").value),
  stock: Number(document.getElementById("edit_stock").value),
  caracteristicas: caracteristicasArray   // 游녣 agregado
};

  if(file){
    const nuevaUrl = await subirImagen(file);
    updateData.imagenes = [nuevaUrl];
  }

  await updateDoc(doc(db,"productos",id), updateData);

  modalEditar.hide();
  cargarAdminProductos();
});


// Cargar productos
async function cargarProductos(){
  const querySnapshot = await getDocs(collection(db,"productos"));
  const contenedor = document.getElementById("productos");
  contenedor.innerHTML="";
  querySnapshot.forEach((docu)=>{
    const data = docu.data();
    contenedor.innerHTML += `
    <div class="card">
	<div class="card-img">
    ${data.stock > 0 
      ? '<span class="badge">Disponible</span>' 
      : '<span class="badge" style="background:#ef4444;">Agotado</span>'}

    <img src="${data.imagenes?.[0]}"
         onclick="verDetalle('${docu.id || 'https://via.placeholder.com/300'}')">
  </div>

  <div class="card-body">
    <h3>${data.nombre}</h3>

    <p class="descripcion">
      ${data.descripcion || "Sin descripci칩n disponible"}
    </p>

    <p class="precio">
      $${data.precio.toLocaleString()}
    </p>

    <button onclick="agregarCarrito('${docu.id}','${data.nombre}',${data.precio})"
    ${data.stock<=0?'disabled':''}>
    ${data.stock<=0?'Agotado':'Agregar al carrito'}
    </button>
  </div>
    </div>`;
  });
}

// Admin productos (editar/eliminar)
async function cargarAdminProductos(){

  const querySnapshot = await getDocs(collection(db,"productos"));
  const cont = document.getElementById("adminProductos");

  cont.innerHTML = `
  <div class="table-responsive">
    <table id="tablaProductos" class="table table-striped table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>Imagen</th>
          <th>Nombre</th>
          <th>Precio</th>
          <th>Stock</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  `;

  const tbody = document.querySelector("#tablaProductos tbody");

  querySnapshot.forEach((docu)=>{
    const data = docu.data();
    const imagen = data.imagenes?.[0] || data.imagen || "https://via.placeholder.com/100";

    const estadoBadge = data.stock > 0
      ? `<span class="badge bg-success">Disponible</span>`
      : `<span class="badge bg-danger">Agotado</span>`;

    tbody.innerHTML += `
      <tr>
        <td>
          <img src="${imagen}" width="60" class="img-thumbnail">
        </td>

        <td>${data.nombre}</td>

        <td>$${data.precio.toLocaleString()}</td>

        <td>${data.stock}</td>

        <td>${estadoBadge}</td>

        <td>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-warning"
              onclick="abrirModalEditar('${docu.id}')">
              Editar
            </button>

            <button class="btn btn-sm btn-danger"
              onclick="eliminarProducto('${docu.id}')">
              Eliminar
            </button>
          </div>
        </td>
      </tr>
    `;
  });

  // 游댠 Activar DataTable
  new DataTable('#tablaProductos', {
    pageLength: 5,
    order: [[3, 'desc']], // ordenar por stock por defecto
    language: {
      search: "Buscar:",
      lengthMenu: "Mostrar _MENU_ registros",
      info: "Mostrando _START_ a _END_ de _TOTAL_ productos",
      paginate: {
        next: "Siguiente",
        previous: "Anterior"
      }
    }
  });

}




function mostrarPanelAdmin(show){
  document.getElementById("panelAdmin").style.display = show ? "block" : "none";
  document.getElementById("loginAdmin").style.display = show ? "none" : "block";
}

// LOGIN
window.login = async function(){
  try{
    await signInWithEmailAndPassword(auth,
      document.getElementById("email").value,
      document.getElementById("password").value);
  } catch (e){
    alert("Error: " + e.message);
  }
}




document.getElementById("btnLogout").addEventListener("click", async () => {
  await signOut(auth);
});

onAuthStateChanged(auth, (user) => {

  if (user) {
    document.getElementById("panelAdmin").classList.remove("d-none");
    
  } else {
    document.getElementById("panelAdmin").classList.add("d-none");
   
  }

});

// Auth state
onAuthStateChanged(auth, async (user) => {
  if(user){
    const admin = await esAdmin(user.uid);
    if(admin){
      mostrarPanelAdmin(true);
      cargarVentas();
      cargarAdminProductos();
    } else {
      alert("No tienes permisos de admin");
      mostrarPanelAdmin(false);
      await signOut(auth);
    }
  } else {
    mostrarPanelAdmin(false);
  }
});


window.verDetalle = function(id){
  window.location.href = `producto.html?id=${id}`;
}

// Editar producto
window.editarProducto = async function(id){

  const fileInput = document.getElementById(`file_${id}`);
  let urlImagen = "";

  if(fileInput && fileInput.files.length > 0){
    urlImagen = await subirImagen(fileInput.files[0]);
  }

  const updateData = {
    // Aqu칤 deber칤as obtener datos desde un modal o formulario
  };

  if(urlImagen){
    updateData.imagenes = [urlImagen];
  }

  await updateDoc(doc(db,"productos",id), updateData);

  cargarAdminProductos();
}


// Eliminar producto
window.eliminarProducto = async function(id){
  await deleteDoc(doc(db,"productos",id));
  cargarProductos();
  cargarAdminProductos();
}


// load pending sales (admin)
async function cargarVentas(){
  const ventasSnap = await getDocs(collection(db,"ventas"));
  const cont = document.getElementById("ventas");
  cont.innerHTML="";

  ventasSnap.forEach(v => {
    const data = v.data();
    if(data.estado === "pendiente"){
      cont.innerHTML += `
        <div style="background:#f1f1f1;margin:10px;padding:10px;border-radius:8px">
          <p><b>ID:</b> ${v.id}</p>
          <p><b>Total:</b> $${data.total.toLocaleString()}</p>
          <p><b>Estado:</b> ${data.estado}</p>
          <p><b>Productos:</b></p>
          <ul>
            ${data.productos.map(p => `<li>${p.nombre} - $${p.precio.toLocaleString()}</li>`).join("")}
          </ul>
          <button onclick="confirmarVenta('${v.id}')">Confirmar Venta</button>
			<button onclick="eliminarVenta('${v.id}')"
			style="background:#ef4444;margin-left:5px;">
			Eliminar
			</button>
        </div>
      `;
    }
  });
}


// confirm sale and decrease stock
window.confirmarVenta = async function(idVenta){
  const ventaRef = doc(db,"ventas",idVenta);
  const ventaSnap = await getDoc(ventaRef);
  const data = ventaSnap.data();

  for(const prod of data.productos){
    const prodRef = doc(db,"productos",prod.id);
    const prodSnap = await getDoc(prodRef);
    const prodData = prodSnap.data();
    await updateDoc(prodRef, { stock: prodData.stock - 1 });
  }

  await updateDoc(ventaRef, { estado: "confirmada" });
  cargarVentas();
}

window.eliminarVenta = async function(idVenta){
  const confirmar = confirm("쯉eguro que deseas eliminar esta venta?");
  if(!confirmar) return;
  await deleteDoc(doc(db,"ventas",idVenta));
 alert("Venta eliminada correctamente");
  cargarVentas();
}


</script>

</body>
</html>
